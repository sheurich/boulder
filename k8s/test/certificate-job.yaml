# Job to generate test certificates
apiVersion: batch/v1
kind: Job
metadata:
  name: boulder-cert-generation
  labels:
    app: boulder-cert-gen
    component: certificate-generation
spec:
  template:
    metadata:
      labels:
        app: boulder-cert-gen
        component: certificate-generation
    spec:
      restartPolicy: Never
      containers:
      - name: cert-gen
        image: letsencrypt/boulder-tools:latest
        command: ["bash", "-c"]
        args:
        - |
          echo "Starting certificate generation..."
          cd /boulder

          # Check if minica is available
          if ! command -v minica >/dev/null 2>&1; then
            echo "Installing minica..."
            go install github.com/jsha/minica@latest
          fi

          # Run certificate generation
          if [ -f "test/certs/generate.sh" ]; then
            echo "Running certificate generation script..."
            chmod +x test/certs/generate.sh
            cd test/certs
            ./generate.sh || {
              echo "Certificate generation failed, creating minimal setup..."
              mkdir -p ipki
              cd ipki
              minica -domains localhost --ip-addresses 127.0.0.1 || echo "Basic cert generation failed"
              cd ..
            }
          else
            echo "Certificate generation script not found, creating basic certs..."
            mkdir -p ipki
            cd ipki
            minica -domains localhost --ip-addresses 127.0.0.1 || echo "Basic cert generation failed"
          fi

          echo "Certificate generation completed"
          ls -la /boulder/test/certs/
        workingDir: /boulder
        env:
        - name: BOULDER_CONFIG_DIR
          value: "test/config"
        - name: GOPATH
          value: "/go"
        - name: GOCACHE
          value: "/tmp/go-cache"
        - name: PATH
          value: "/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        volumeMounts:
        - name: cert-storage
          mountPath: /boulder/test/certs
        - name: softhsm-tokens
          mountPath: /var/lib/softhsm/tokens
        - name: go-cache
          mountPath: /tmp/go-cache
        - name: go-path
          mountPath: /go
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"
      volumes:
      - name: cert-storage
        emptyDir:
          sizeLimit: 100Mi
      - name: softhsm-tokens
        emptyDir:
          sizeLimit: 100Mi
      - name: go-cache
        emptyDir:
          sizeLimit: 500Mi
      - name: go-path
        emptyDir:
          sizeLimit: 1Gi
  backoffLimit: 3
  activeDeadlineSeconds: 900  # 15 minutes timeout